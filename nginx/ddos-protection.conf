# Nginx DDoS 방어 설정
# 슬로우 로리스 공격, 대용량 요청, 악성 트래픽 차단

# ============================================
# 요청 크기 제한 (Request Size Limits)
# ============================================
# 클라이언트 요청 바디 최대 크기 (파일 업로드 제한)
client_max_body_size 10M;

# 클라이언트 바디 버퍼 크기
client_body_buffer_size 128k;

# 클라이언트 헤더 버퍼 크기
client_header_buffer_size 1k;

# 큰 헤더를 위한 버퍼 (4개 x 8k)
large_client_header_buffers 4 8k;

# ============================================
# 타임아웃 설정 (Timeout Settings)
# ============================================
# 슬로우 로리스 공격 방어

# 클라이언트 바디 읽기 타임아웃 (10초)
client_body_timeout 10s;

# 클라이언트 헤더 읽기 타임아웃 (10초)
client_header_timeout 10s;

# Keep-Alive 타임아웃 (30초)
keepalive_timeout 30s;

# 응답 전송 타임아웃 (10초)
send_timeout 10s;

# ============================================
# 연결 설정 (Connection Settings)
# ============================================
# Keep-Alive 요청 제한 (하나의 연결에서 최대 100개 요청)
keepalive_requests 100;

# ============================================
# 버퍼 오버플로우 방어
# ============================================
# 잘못된 HTTP 버전 차단
if ($http_version !~ "^HTTP/(1\.0|1\.1|2\.0)$") {
    return 400;
}

# ============================================
# 악성 User-Agent 차단
# ============================================
# 알려진 봇 및 스캐너 차단
map $http_user_agent $bad_bot {
    default 0;
    ~*nikto 1;
    ~*sqlmap 1;
    ~*nmap 1;
    ~*masscan 1;
    ~*zgrab 1;
    ~*python-requests 1;  # 악의적 Python 스크립트
    ~*scrapy 1;           # 무단 크롤러
}

# ============================================
# 적용 예시 (server 블록에서 사용)
# ============================================
# server {
#     # 악성 봇 차단
#     if ($bad_bot) {
#         return 403;
#     }
#
#     # 빈 User-Agent 차단
#     if ($http_user_agent = "") {
#         return 403;
#     }
#
#     # 직접 IP 접근 차단 (도메인 접근만 허용)
#     if ($host !~* ^(leeeunseok\.tail32c3e2\.ts\.net|localhost)$) {
#         return 444;  # Nginx 특수 코드 (연결 종료)
#     }
# }

# ============================================
# HTTP Method 제한
# ============================================
# 허용된 HTTP 메소드만 허용 (GET, POST, PUT, DELETE, PATCH, OPTIONS)
map $request_method $not_allowed_method {
    default 1;
    GET 0;
    POST 0;
    PUT 0;
    DELETE 0;
    PATCH 0;
    OPTIONS 0;
    HEAD 0;
}

# 사용 예시:
# if ($not_allowed_method) {
#     return 405;  # Method Not Allowed
# }

# ============================================
# 특정 경로 차단
# ============================================
# 알려진 취약점 경로 차단
location ~* (\.env|\.git|\.svn|\.htaccess|\.htpasswd|web\.config|\.DS_Store) {
    deny all;
    return 404;
}

# ============================================
# Flood 공격 방어 (Nginx Plus 기능 - Open Source에서는 limit_req 사용)
# ============================================
# limit_req_zone으로 대체:
#   - rate-limit.conf 참조

# ============================================
# 모니터링 및 로깅
# ============================================
# 차단된 요청 로깅
log_format ddos_log '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'limit_req_status=$limit_req_status';

# 사용 예시:
# access_log /var/log/nginx/ddos.log ddos_log;

# ============================================
# 추천 설정 조합
# ============================================
# 1. rate-limit.conf (요청 빈도 제한)
# 2. ddos-protection.conf (본 파일 - 타임아웃, 크기 제한)
# 3. ip-whitelist.conf (IP 기반 접근 제어)
# 4. Fail2Ban (반복적인 공격 IP 자동 차단)
