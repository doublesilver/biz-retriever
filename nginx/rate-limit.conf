# Nginx Rate Limiting 설정
# DDoS 방어 및 API 남용 방지

# ============================================
# 연결 레벨 제한 (Connection Limit)
# ============================================
# IP당 최대 동시 연결 수 제한
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

# ============================================
# 요청 레벨 제한 (Request Rate Limit)
# ============================================
# API 요청 제한: 초당 10회 (burst 20회)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# 정적 파일 제한: 초당 50회 (burst 100회)
limit_req_zone $binary_remote_addr zone=static_limit:10m rate=50r/s;

# 로그인 시도 제한: 분당 5회 (브루트포스 방어)
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

# ============================================
# 적용 (server 또는 location 블록에서 사용)
# ============================================
# 사용 예시:
# 
# server {
#     # 연결 수 제한 (IP당 최대 10개 동시 연결)
#     limit_conn conn_limit_per_ip 10;
#
#     # API 엔드포인트
#     location /api/ {
#         limit_req zone=api_limit burst=20 nodelay;
#         limit_req_status 429;  # Too Many Requests
#         proxy_pass http://backend;
#     }
#
#     # 정적 파일 (완화된 제한)
#     location ~* \.(css|js|jpg|png|gif|ico|woff|woff2)$ {
#         limit_req zone=static_limit burst=100;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#     }
#
#     # 로그인 엔드포인트 (엄격한 제한)
#     location /api/v1/auth/login {
#         limit_req zone=login_limit burst=2 nodelay;
#         limit_req_status 429;
#         proxy_pass http://backend;
#     }
# }

# ============================================
# 설명
# ============================================
# 
# limit_conn_zone:
#   - $binary_remote_addr: IP 주소 기반
#   - zone=name:10m: 10MB 메모리 (약 160,000개 IP 추적 가능)
#
# limit_req_zone:
#   - rate=10r/s: 초당 10회 요청
#   - rate=5r/m: 분당 5회 요청
#
# limit_req 옵션:
#   - burst=20: 순간적으로 20개까지 큐에 저장
#   - nodelay: 큐 대기 없이 즉시 처리 (지연 없음)
#   - delay=10: 10개까지는 즉시 처리, 이후는 지연
#
# limit_req_status:
#   - 429: HTTP 429 Too Many Requests 응답
#
# ============================================
# 모니터링
# ============================================
# Nginx 로그에서 Rate Limit 확인:
#   tail -f /var/log/nginx/error.log | grep limiting
#
# 예상 로그:
#   [error] limiting requests, excess: 5.123 by zone "api_limit"
