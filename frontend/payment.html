<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ ë° êµ¬ë… ê´€ë¦¬ - Biz-Retriever</title>
    <link rel="stylesheet" href="css/variables.css?v=v4">
    <link rel="stylesheet" href="css/reset.css?v=v4">
    <link rel="stylesheet" href="css/components.css?v=v4">
    <link rel="stylesheet" href="css/main.css?v=v4">
    <link rel="stylesheet" href="css/dashboard.css?v=v4">
    <link rel="stylesheet" href="css/accessibility.css?v=v4">

    <!-- Tosspayments SDK -->
    <script src="https://js.tosspayments.com/v2/standard"></script>

    <style>
        .payment-layout {
            max-width: 960px;
            margin: 0 auto;
            padding: var(--spacing-6) var(--spacing-4);
        }

        .payment-page-header {
            margin-bottom: var(--spacing-8);
        }

        .payment-page-header h2 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }

        .payment-page-header p {
            color: var(--text-secondary);
            font-size: var(--font-size-base);
        }

        /* Current Subscription Banner */
        .subscription-banner {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            margin-bottom: var(--spacing-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-4);
        }

        .subscription-banner .sub-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }

        .subscription-banner .sub-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .subscription-banner .sub-icon.free { background: var(--gray-100); }
        .subscription-banner .sub-icon.basic { background: var(--info-light); }
        .subscription-banner .sub-icon.pro { background: var(--warning-light); }

        .subscription-banner .sub-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .subscription-banner .sub-plan {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .subscription-banner .sub-next-billing {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
        }

        /* Plan Cards Grid */
        .plans-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-8);
        }

        @media (max-width: 768px) {
            .plans-grid {
                grid-template-columns: 1fr;
            }
        }

        .plan-card {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
        }

        .plan-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .plan-card.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.03);
        }

        .plan-card.current {
            border-color: var(--success);
        }

        .plan-card .plan-badge {
            position: absolute;
            top: -10px;
            right: var(--spacing-4);
            padding: 0.2rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
        }

        .plan-badge.current-badge {
            background: var(--success-light);
            color: var(--success);
        }

        .plan-badge.popular-badge {
            background: var(--primary);
            color: white;
        }

        .plan-card h3 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }

        .plan-card .plan-desc {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-4);
        }

        .plan-price {
            margin-bottom: var(--spacing-5);
        }

        .plan-price .amount {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .plan-price .period {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
        }

        .plan-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plan-features li {
            padding: 0.4rem 0;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .plan-features li .check {
            color: var(--success);
            font-weight: bold;
            flex-shrink: 0;
        }

        .plan-features li.disabled {
            color: var(--text-disabled);
            text-decoration: line-through;
        }

        .plan-features li.disabled .check {
            color: var(--text-disabled);
        }

        /* Payment Action */
        .payment-action {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            margin-bottom: var(--spacing-8);
        }

        .payment-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3) 0;
        }

        .payment-summary-row + .payment-summary-row {
            border-top: 1px solid var(--border-color);
        }

        .payment-summary-row.total {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            color: var(--text-primary);
            border-top: 2px solid var(--border-color);
            padding-top: var(--spacing-4);
            margin-top: var(--spacing-2);
        }

        .btn-pay {
            width: 100%;
            height: 56px;
            font-size: var(--font-size-lg);
            margin-top: var(--spacing-5);
        }

        .payment-note {
            margin-top: var(--spacing-3);
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            text-align: center;
        }

        /* Payment History Section */
        .payment-history {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .payment-history-header {
            padding: var(--spacing-5);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .payment-history-header h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .history-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: var(--spacing-4);
            align-items: center;
            padding: var(--spacing-4) var(--spacing-5);
            border-bottom: 1px solid var(--border-color);
            font-size: var(--font-size-sm);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item .history-date {
            color: var(--text-tertiary);
            font-size: var(--font-size-xs);
        }

        .history-empty {
            padding: var(--spacing-8);
            text-align: center;
            color: var(--text-tertiary);
        }

        /* Cancel Subscription Modal */
        .cancel-reason-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .cancel-reason-list label {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: var(--font-size-sm);
        }

        .cancel-reason-list label:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: var(--spacing-4);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay .loading-text {
            color: white;
            font-size: var(--font-size-base);
        }

        .loading-overlay .loading-spinner-lg {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>

<body>
    <!-- Skip Navigation -->
    <a href="#plans-grid" class="skip-link">í”Œëœ ì„ íƒìœ¼ë¡œ ê±´ë„ˆë›°ê¸°</a>
    <!-- Navbar -->
    <nav class="navbar" role="navigation" aria-label="ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜">
        <div class="navbar-brand">
            <a href="dashboard.html">
                <span aria-hidden="true">ğŸ•</span>
                <span>Biz-Retriever</span>
            </a>
        </div>
        <div class="navbar-actions">
            <a href="dashboard.html" class="btn-icon" title="ëŒ€ì‹œë³´ë“œ" aria-label="ëŒ€ì‹œë³´ë“œ">
                <span aria-hidden="true">ğŸ </span>
            </a>
            <a href="profile.html" class="btn-icon" title="í”„ë¡œí•„" aria-label="í”„ë¡œí•„">
                <span aria-hidden="true">ğŸ¢</span>
            </a>
        </div>
    </nav>

    <main class="dashboard-container">
        <div class="payment-layout">
            <!-- Page Header -->
            <div class="payment-page-header">
                <h2>ê²°ì œ ë° êµ¬ë… ê´€ë¦¬</h2>
                <p>í”Œëœì„ ì„ íƒí•˜ê³  ê²°ì œë¥¼ ì§„í–‰í•˜ì„¸ìš”. ì–¸ì œë“ ì§€ ë³€ê²½í•˜ê±°ë‚˜ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <!-- Current Subscription Banner (Skeleton by default) -->
            <div class="subscription-banner" id="subscription-banner">
                <div style="display: flex; gap: 1rem; align-items: center; width: 100%;">
                    <div class="skeleton" style="width: 48px; height: 48px; border-radius: var(--radius-lg);"></div>
                    <div style="flex: 1;">
                        <div class="skeleton" style="width: 80px; height: 0.75rem; margin-bottom: 0.5rem;"></div>
                        <div class="skeleton" style="width: 120px; height: 1.25rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Plan Cards -->
            <div class="plans-grid" id="plans-grid">
                <!-- Skeleton Loading -->
                <div style="padding: 2rem; background: var(--bg-primary); border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
                    <div class="skeleton" style="width: 40%; height: 1.5rem; margin-bottom: 1rem;"></div>
                    <div class="skeleton" style="width: 50%; height: 2.5rem; margin-bottom: 1.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 70%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                </div>
                <div style="padding: 2rem; background: var(--bg-primary); border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
                    <div class="skeleton" style="width: 40%; height: 1.5rem; margin-bottom: 1rem;"></div>
                    <div class="skeleton" style="width: 50%; height: 2.5rem; margin-bottom: 1.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 70%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                </div>
                <div style="padding: 2rem; background: var(--bg-primary); border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
                    <div class="skeleton" style="width: 40%; height: 1.5rem; margin-bottom: 1rem;"></div>
                    <div class="skeleton" style="width: 50%; height: 2.5rem; margin-bottom: 1.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 70%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                </div>
            </div>

            <!-- Payment Action Section (hidden initially) -->
            <div class="payment-action" id="payment-action" style="display: none;">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); margin-bottom: var(--spacing-4);">ê²°ì œ ì •ë³´</h3>
                <div class="payment-summary-row">
                    <span style="color: var(--text-secondary);">ì„ íƒí•œ í”Œëœ</span>
                    <span id="summary-plan-name" style="font-weight: var(--font-weight-semibold);">-</span>
                </div>
                <div class="payment-summary-row">
                    <span style="color: var(--text-secondary);">ê²°ì œ ì£¼ê¸°</span>
                    <span>ì›”ê°„ êµ¬ë…</span>
                </div>
                <div class="payment-summary-row total">
                    <span>ì´ ê²°ì œ ê¸ˆì•¡</span>
                    <span id="summary-amount" style="color: var(--primary);">-</span>
                </div>
                <button class="btn btn-primary btn-pay" id="btn-pay" onclick="handlePayment()">
                    ê²°ì œí•˜ê¸°
                </button>
                <p class="payment-note">
                    ì›” ë‹¨ìœ„ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤. ë‹¤ìŒ ê²°ì œì¼ ì „ ì–¸ì œë“ ì§€ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- Cancel Subscription (visible only for paid plans) -->
            <div id="cancel-section" style="display: none; margin-bottom: var(--spacing-8);">
                <button class="btn btn-outline" style="color: var(--danger); border-color: var(--danger);" onclick="showCancelModal()">
                    êµ¬ë… ì·¨ì†Œ
                </button>
            </div>

            <!-- Payment History -->
            <div class="payment-history">
                <div class="payment-history-header">
                    <h3>ê²°ì œ ë‚´ì—­</h3>
                </div>
                <div id="payment-history-list">
                    <div class="history-empty">ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Cancel Modal -->
    <div id="cancelModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cancelModalTitle">
        <div class="modal-backdrop" onclick="closeCancelModal()"></div>
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header">
                <h3 id="cancelModalTitle">êµ¬ë… ì·¨ì†Œ</h3>
                <button class="btn-icon modal-close" onclick="closeCancelModal()">X</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: var(--spacing-4); color: var(--text-secondary);">
                    êµ¬ë…ì„ ì·¨ì†Œí•˜ì‹œë©´ í˜„ì¬ ê²°ì œ ê¸°ê°„ì´ ëë‚œ í›„ ë¬´ë£Œ í”Œëœìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.
                </p>
                <div class="cancel-reason-list" id="cancel-reasons">
                    <label><input type="radio" name="cancelReason" value="too_expensive"> ê°€ê²©ì´ ë¹„ìŒ‰ë‹ˆë‹¤</label>
                    <label><input type="radio" name="cancelReason" value="not_using"> ì„œë¹„ìŠ¤ë¥¼ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</label>
                    <label><input type="radio" name="cancelReason" value="missing_features"> í•„ìš”í•œ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤</label>
                    <label><input type="radio" name="cancelReason" value="switching"> ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¡œ ë³€ê²½í•©ë‹ˆë‹¤</label>
                    <label><input type="radio" name="cancelReason" value="other"> ê¸°íƒ€</label>
                </div>
                <textarea id="cancelReasonDetail" class="form-control" placeholder="ì¶”ê°€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒ)" style="margin-top: var(--spacing-4); min-height: 80px; width: 100%; padding: var(--spacing-3);"></textarea>
            </div>
            <div class="modal-footer" style="padding: var(--spacing-5); border-top: 1px solid var(--border-color); display: flex; gap: var(--spacing-3); justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCancelModal()">ëŒì•„ê°€ê¸°</button>
                <button class="btn" style="background: var(--danger); color: white;" id="confirmCancelBtn" onclick="confirmCancel()">êµ¬ë… ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner-lg"></div>
        <div class="loading-text">ê²°ì œ ì²˜ë¦¬ ì¤‘...</div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script src="js/config.js?v=v4"></script>
    <script src="js/utils.js?v=v4"></script>
    <script src="js/api.js?v=v4"></script>
    <script>
        // State
        let selectedPlan = null;
        let currentSubscription = null;
        let currentPaymentKey = null;

        // Plan data with full feature comparison
        const plans = {
            free: {
                name: 'Free',
                price: 0,
                desc: 'ì…ì°° ê³µê³  ì„œë¹„ìŠ¤ë¥¼ ì²´í—˜í•´ë³´ì„¸ìš”',
                features: [
                    { text: 'ë§ì¶¤ ê³µê³  3ê±´/ì¼', enabled: true },
                    { text: 'ê¸°ë³¸ ê²€ìƒ‰', enabled: true },
                    { text: 'í‚¤ì›Œë“œ 5ê°œ ë“±ë¡', enabled: true },
                    { text: 'AI ë¶„ì„', enabled: false },
                    { text: 'ì´ë©”ì¼/Slack ì•Œë¦¼', enabled: false },
                    { text: 'Excel ë‚´ë³´ë‚´ê¸°', enabled: false },
                    { text: 'ìš°ì„  ì§€ì›', enabled: false }
                ]
            },
            basic: {
                name: 'Basic',
                price: 10000,
                desc: 'ì†Œê·œëª¨ ì‚¬ì—…ìë¥¼ ìœ„í•œ í•„ìˆ˜ ê¸°ëŠ¥',
                features: [
                    { text: 'ë§ì¶¤ ê³µê³  50ê±´/ì¼', enabled: true },
                    { text: 'ì‹œë§¨í‹± ê²€ìƒ‰', enabled: true },
                    { text: 'í‚¤ì›Œë“œ 20ê°œ ë“±ë¡', enabled: true },
                    { text: 'AI ë¶„ì„ 100ê±´/ì¼', enabled: true },
                    { text: 'ì´ë©”ì¼ ì•Œë¦¼', enabled: true },
                    { text: 'Excel ë‚´ë³´ë‚´ê¸°', enabled: true },
                    { text: 'ìš°ì„  ì§€ì›', enabled: false }
                ]
            },
            pro: {
                name: 'Pro',
                price: 30000,
                desc: 'ì„±ì¥í•˜ëŠ” ê¸°ì—…ì„ ìœ„í•œ ë¬´ì œí•œ í”Œëœ',
                popular: true,
                features: [
                    { text: 'ë§ì¶¤ ê³µê³  ë¬´ì œí•œ', enabled: true },
                    { text: 'ì‹œë§¨í‹± ê²€ìƒ‰', enabled: true },
                    { text: 'í‚¤ì›Œë“œ 100ê°œ ë“±ë¡', enabled: true },
                    { text: 'AI ë¶„ì„ ë¬´ì œí•œ', enabled: true },
                    { text: 'ì´ë©”ì¼ + Slack ì•Œë¦¼', enabled: true },
                    { text: 'Excel ë‚´ë³´ë‚´ê¸°', enabled: true },
                    { text: 'ìš°ì„  ì§€ì›', enabled: true }
                ]
            }
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            if (!localStorage.getItem('token')) {
                window.location.href = '/index.html';
                return;
            }

            await loadCurrentSubscription();
            renderPlanCards();
            await loadPaymentHistory();

            // Check URL params for pre-selected plan
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedPlan = urlParams.get('plan');
            if (preselectedPlan && plans[preselectedPlan]) {
                selectPlan(preselectedPlan);
            }
        });

        async function loadCurrentSubscription() {
            try {
                const profile = await API.getProfile();
                currentSubscription = {
                    plan_name: profile.plan_name || 'free',
                    is_active: true,
                    next_billing_date: profile.next_billing_date || null
                };
            } catch (error) {
                console.error('Failed to load subscription:', error);
                currentSubscription = { plan_name: 'free', is_active: true };
            }
            renderSubscriptionBanner();
        }

        function renderSubscriptionBanner() {
            const banner = document.getElementById('subscription-banner');
            const plan = currentSubscription.plan_name || 'free';
            const planData = plans[plan] || plans.free;

            const iconMap = { free: 'ğŸ†“', basic: 'â­', pro: 'ğŸ‘‘' };
            const nextBilling = currentSubscription.next_billing_date
                ? utils.formatDateKR(currentSubscription.next_billing_date)
                : null;

            banner.innerHTML = `
                <div class="sub-info">
                    <div class="sub-icon ${plan}">${iconMap[plan] || 'ğŸ†“'}</div>
                    <div>
                        <div class="sub-label">í˜„ì¬ í”Œëœ</div>
                        <div class="sub-plan">${planData.name}</div>
                        ${nextBilling ? `<div class="sub-next-billing">ë‹¤ìŒ ê²°ì œì¼: ${nextBilling}</div>` : ''}
                    </div>
                </div>
                ${plan !== 'free' ? `<span class="badge success">í™œì„±</span>` : ''}
            `;

            // Show cancel button for paid plans
            document.getElementById('cancel-section').style.display = plan !== 'free' ? 'block' : 'none';
        }

        function renderPlanCards() {
            const grid = document.getElementById('plans-grid');
            const currentPlan = currentSubscription ? currentSubscription.plan_name : 'free';

            grid.innerHTML = Object.entries(plans).map(([key, plan]) => {
                const isCurrent = key === currentPlan;
                const isSelected = key === selectedPlan;

                let badgeHtml = '';
                if (isCurrent) {
                    badgeHtml = '<span class="plan-badge current-badge">í˜„ì¬ í”Œëœ</span>';
                } else if (plan.popular) {
                    badgeHtml = '<span class="plan-badge popular-badge">ì¸ê¸°</span>';
                }

                return `
                    <div class="plan-card ${isSelected ? 'selected' : ''} ${isCurrent ? 'current' : ''}"
                         onclick="selectPlan('${key}')"
                         data-plan="${key}">
                        ${badgeHtml}
                        <h3>${plan.name}</h3>
                        <p class="plan-desc">${plan.desc}</p>
                        <div class="plan-price">
                            <span class="amount">${plan.price === 0 ? 'ë¬´ë£Œ' : plan.price.toLocaleString() + 'ì›'}</span>
                            ${plan.price > 0 ? '<span class="period"> /ì›”</span>' : ''}
                        </div>
                        <ul class="plan-features">
                            ${plan.features.map(f => `
                                <li class="${f.enabled ? '' : 'disabled'}">
                                    <span class="check">${f.enabled ? 'âœ“' : 'â€”'}</span>
                                    ${f.text}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }).join('');
        }

        function selectPlan(planKey) {
            const currentPlan = currentSubscription ? currentSubscription.plan_name : 'free';

            // ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í”Œëœì´ë©´ ë¬´ì‹œ
            if (planKey === currentPlan) {
                utils.showToast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í”Œëœì…ë‹ˆë‹¤.', 'info');
                return;
            }

            // ë¬´ë£Œ í”Œëœ ì„ íƒ ì‹œ ë‹¤ìš´ê·¸ë ˆì´ë“œ ì•ˆë‚´
            if (planKey === 'free') {
                if (currentPlan !== 'free') {
                    showCancelModal();
                }
                return;
            }

            selectedPlan = planKey;

            // Update plan card UI
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.plan === planKey);
            });

            // Show payment section
            const paymentAction = document.getElementById('payment-action');
            paymentAction.style.display = 'block';
            document.getElementById('summary-plan-name').textContent = plans[planKey].name;
            document.getElementById('summary-amount').textContent = plans[planKey].price.toLocaleString() + 'ì›';

            // Scroll to payment section
            paymentAction.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function handlePayment() {
            if (!selectedPlan) {
                utils.showToast('í”Œëœì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const payBtn = document.getElementById('btn-pay');
            utils.setLoading(payBtn, true);

            try {
                showLoading(true, 'ê²°ì œ ì¤€ë¹„ ì¤‘...');

                // Create payment request to backend
                const response = await API.createPayment(selectedPlan);

                if (!response.client_key) {
                    throw new Error('ê²°ì œ ì‹œìŠ¤í…œ ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }

                showLoading(true, 'ê²°ì œì°½ì„ ì—¬ëŠ” ì¤‘...');

                // Initialize Tosspayments V2
                const tossPayments = TossPayments(response.client_key);
                const payment = tossPayments.payment({ customerKey: response.customerEmail });

                // Request payment
                await payment.requestPayment({
                    method: 'CARD',
                    amount: {
                        value: response.amount,
                        currency: 'KRW'
                    },
                    orderId: response.orderId,
                    orderName: response.orderName,
                    customerName: response.customerName,
                    customerEmail: response.customerEmail,
                    successUrl: response.successUrl,
                    failUrl: response.failUrl
                });

            } catch (error) {
                showLoading(false);
                utils.setLoading(payBtn, false);
                console.error('Payment error:', error);

                // Tosspayments SDK error codes
                if (error.code === 'USER_CANCEL') {
                    utils.showToast('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                } else if (error.code === 'INVALID_CARD_COMPANY') {
                    utils.showToast('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì¹´ë“œì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì¹´ë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.isRetryable) {
                    utils.showActionToast(
                        error.message || 'ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                        'error',
                        { actionText: 'ë‹¤ì‹œ ì‹œë„', onAction: handlePayment }
                    );
                } else {
                    utils.showToast(error.message || 'ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        async function loadPaymentHistory() {
            const listEl = document.getElementById('payment-history-list');

            try {
                const history = await API.getPaymentHistory();

                if (!history || history.length === 0) {
                    listEl.innerHTML = '<div class="history-empty">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                listEl.innerHTML = history.map(item => {
                    const statusInfo = utils.formatPaymentStatus(item.status);
                    const date = new Date(item.created_at);
                    const dateStr = date.toLocaleDateString('ko-KR', {
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    });

                    return `
                        <div class="history-item">
                            <div>
                                <div style="font-weight: var(--font-weight-medium); color: var(--text-primary);">
                                    ${item.amount.toLocaleString()}ì›
                                </div>
                                <div class="history-date">${dateStr} | ${item.payment_method}</div>
                            </div>
                            <span class="badge ${statusInfo.class}">${statusInfo.text}</span>
                            ${item.status === 'paid' ? `
                                <button class="btn btn-sm btn-secondary" onclick="requestRefund('${item.transaction_id}')">
                                    í™˜ë¶ˆ ìš”ì²­
                                </button>
                            ` : '<span></span>'}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load payment history:', error);
                listEl.innerHTML = `
                    <div class="history-empty">
                        <p>ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
                        <button class="btn btn-sm btn-outline" onclick="loadPaymentHistory()" style="margin-top: 0.5rem;">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        async function requestRefund(paymentKey) {
            if (!confirm('ì •ë§ í™˜ë¶ˆì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™˜ë¶ˆ ì‹œ ë¬´ë£Œ í”Œëœìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                showLoading(true, 'í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘...');
                await API.cancelPayment(paymentKey, 'ì‚¬ìš©ì ìš”ì²­ í™˜ë¶ˆ');
                showLoading(false);
                utils.showToast('í™˜ë¶ˆì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // Reload data
                await loadCurrentSubscription();
                renderPlanCards();
                await loadPaymentHistory();
            } catch (error) {
                showLoading(false);
                utils.showToast('í™˜ë¶ˆ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function showCancelModal() {
            document.getElementById('cancelModal').classList.add('active');
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('active');
        }

        async function confirmCancel() {
            const reasonRadio = document.querySelector('input[name="cancelReason"]:checked');
            if (!reasonRadio) {
                utils.showToast('ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const detail = document.getElementById('cancelReasonDetail').value.trim();
            const reason = reasonRadio.value + (detail ? ': ' + detail : '');

            const cancelBtn = document.getElementById('confirmCancelBtn');
            utils.setLoading(cancelBtn, true);

            try {
                // If there's a current payment key, cancel via API
                if (currentPaymentKey) {
                    await API.cancelPayment(currentPaymentKey, reason);
                }

                closeCancelModal();
                utils.showToast('êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¬´ë£Œ í”Œëœìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.', 'success');

                // Reload
                await loadCurrentSubscription();
                renderPlanCards();
                selectedPlan = null;
                document.getElementById('payment-action').style.display = 'none';
                await loadPaymentHistory();
            } catch (error) {
                utils.showToast('êµ¬ë… ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message, 'error');
            } finally {
                utils.setLoading(cancelBtn, false);
            }
        }

        function showLoading(show, message) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.add('active');
                if (message) {
                    overlay.querySelector('.loading-text').textContent = message;
                }
            } else {
                overlay.classList.remove('active');
            }
        }

        // Exports
        window.handlePayment = handlePayment;
        window.requestRefund = requestRefund;
        window.showCancelModal = showCancelModal;
        window.closeCancelModal = closeCancelModal;
        window.confirmCancel = confirmCancel;
    </script>
</body>

</html>
