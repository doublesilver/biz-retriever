# ==========================================================
# Automated Database Backup
# ==========================================================
# 학습 노트:
#
# 왜 DB 백업을 자동화하는가?
# 서비스의 데이터는 자산입니다. 서버 장애, 실수로 인한 데이터 삭제 등에 대비하여
# 정기적으로 백업을 만들어야 합니다.
#
# 이 워크플로우는 매일 새벽 3시(KST)에 Railway PostgreSQL 백업을 생성하고
# GitHub Artifact로 보관합니다 (90일 보존).
#
# Railway는 자체 백업도 제공하지만, 외부 백업은 추가 안전장치입니다.
# ==========================================================

name: Database Backup

on:
  schedule:
    # 매일 새벽 3시 KST (UTC 18:00)
    - cron: "0 18 * * *"
  workflow_dispatch: # 수동 트리거 가능

permissions:
  contents: read

jobs:
  backup:
    name: PostgreSQL Backup
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-15

      - name: Create backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "DATABASE_URL not set, skipping backup"
            exit 0
          fi

          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="db_backup_${TIMESTAMP}.sql.gz"

          echo "Creating backup: $BACKUP_FILE"
          pg_dump "$DATABASE_URL" \
            --no-owner \
            --no-privileges \
            --clean \
            --if-exists \
            | gzip > "$BACKUP_FILE"

          echo "Backup size: $(ls -lh $BACKUP_FILE | awk '{print $5}')"
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV

      - name: Upload backup artifact
        if: env.BACKUP_FILE
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: 90

      - name: Notify on failure
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"text": "Database backup failed. Check GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi
